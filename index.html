<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parquet Viewer</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #2563eb;
        }
        .drop-zone {
            border: 3px dashed #2563eb;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s;
            cursor: pointer;
            background: #fff;
        }
        .drop-zone:hover, .drop-zone.dragover {
            background: #eff6ff;
            border-color: #1d4ed8;
        }
        .drop-zone p {
            font-size: 18px;
            color: #666;
        }
        .drop-zone .icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        #fileInput {
            display: none;
        }
        .info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            padding: 12px 15px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .info-bar span {
            color: #2563eb;
            font-weight: 600;
        }
        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .controls input, .controls select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #fff;
            color: #333;
        }
        .controls input:focus, .controls select:focus {
            outline: none;
            border-color: #2563eb;
        }
        .controls button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: #2563eb;
            color: #fff;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        .controls button:hover {
            background: #1d4ed8;
        }
        .table-container {
            overflow-x: auto;
            background: #fff;
            border-radius: 8px;
            max-height: 65vh;
            overflow-y: auto;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
            white-space: nowrap;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        th {
            background: #f8fafc;
            color: #1e40af;
            position: sticky;
            top: 0;
            z-index: 10;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
            cursor: pointer;
            user-select: none;
        }
        th:hover {
            background: #e2e8f0;
        }
        th .col-name {
            font-weight: 600;
        }
        th .col-type {
            font-weight: normal;
            font-size: 11px;
            color: #64748b;
        }
        th .sort-indicator {
            margin-left: 4px;
            color: #2563eb;
        }
        tr:hover {
            background: #f8fafc;
        }
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }
        .pagination button {
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            background: #2563eb;
            color: #fff;
            cursor: pointer;
            font-weight: bold;
        }
        .pagination button:disabled {
            background: #cbd5e1;
            color: #94a3b8;
            cursor: not-allowed;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #2563eb;
        }
        .error {
            text-align: center;
            padding: 20px;
            color: #dc2626;
            background: #fef2f2;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #fecaca;
        }
        .hidden {
            display: none;
        }
        .null-value {
            color: #94a3b8;
            font-style: italic;
        }
        
        /* Stats Section */
        .stats-section {
            margin-bottom: 15px;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .stats-section h3 {
            color: #1e40af;
            margin-bottom: 10px;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stats-table {
            width: 100%;
            font-size: 13px;
            overflow-x: auto;
            display: block;
        }
        .stats-table th, .stats-table td {
            padding: 8px 10px;
            text-align: left;
            white-space: nowrap;
        }
        .stats-table th {
            background: #f1f5f9;
            cursor: default;
        }
        .stats-table th:hover {
            background: #f1f5f9;
        }
        
        .toggle-btn {
            font-size: 12px;
            padding: 4px 10px;
            background: #e2e8f0;
            color: #475569;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .toggle-btn:hover {
            background: #cbd5e1;
        }
    </style>
</head>
<body ondragover="event.preventDefault()" ondrop="event.preventDefault()">
    <h1>üìä Parquet Viewer</h1>
    
    <div class="drop-zone" id="dropZone">
        <div class="icon">üìÅ</div>
        <p>Parquet„Éï„Ç°„Ç§„É´„Çí„Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó<br>„Åæ„Åü„ÅØ„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÈÅ∏Êäû</p>
        <input type="file" id="fileInput" accept=".parquet,.parq">
    </div>
    
    <div id="content" class="hidden">
        <div class="info-bar">
            <div>
                „Éï„Ç°„Ç§„É´: <span id="fileName"></span> | 
                Ë°åÊï∞: <span id="rowCount"></span> | 
                „Ç´„É©„É†Êï∞: <span id="colCount"></span>
            </div>
            <div class="controls">
                <input type="text" id="searchInput" placeholder="Ê§úÁ¥¢..." style="width:150px;">
                <select id="pageSize">
                    <option value="50">50‰ª∂</option>
                    <option value="100" selected>100‰ª∂</option>
                    <option value="500">500‰ª∂</option>
                    <option value="1000">1000‰ª∂</option>
                </select>
                <button id="exportBtn">CSVÂá∫Âäõ</button>
            </div>
        </div>
        
        <!-- Stats Section -->
        <div class="stats-section" id="statsSection">
            <h3>
                Áµ±Ë®àÊÉÖÂ†±
                <button class="toggle-btn" id="statsToggle">ÈùûË°®Á§∫</button>
            </h3>
            <div id="statsContent">
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>ÈÄöÁï™</th>
                            <th>„Ç´„É©„É†</th>
                            <th>Âûã</th>
                            <th>‰ª∂Êï∞</th>
                            <th>NULLÊï∞</th>
                            <th>NULLÁéá</th>
                            <th>„É¶„Éã„Éº„ÇØÊï∞</th>
                            <th>ÊúÄÂ∞è</th>
                            <th>ÊúÄÂ§ß</th>
                        </tr>
                    </thead>
                    <tbody id="statsBody"></tbody>
                </table>
            </div>
        </div>
        
        <div class="table-container">
            <table id="dataTable">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        
        <div class="pagination">
            <button id="prevBtn">‚Üê Ââç„Å∏</button>
            <span id="pageInfo"></span>
            <button id="nextBtn">Ê¨°„Å∏ ‚Üí</button>
        </div>
    </div>
    
    <div id="loading" class="loading hidden">
        <div>Ë™≠„ÅøËæº„Åø‰∏≠...</div>
    </div>
    <div id="error" class="error hidden"></div>

    <script type="module">
        import { parquetRead, parquetMetadataAsync, parquetSchema } from './lib/index.js';
        
        let allData = [];
        let columns = [];
        let currentPage = 0;
        let pageSize = 100;
        let filteredData = [];
        let currentFileName = '';
        let sortColumn = null;
        let sortDirection = 'asc';
        let statsVisible = true;
        
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) loadFile(file);
        });
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) loadFile(file);
        });
        
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            if (!query) {
                filteredData = allData;
            } else {
                filteredData = allData.filter(row => 
                    Object.values(row).some(val => 
                        String(val).toLowerCase().includes(query)
                    )
                );
            }
            currentPage = 0;
            renderTable();
        });
        
        document.getElementById('pageSize').addEventListener('change', (e) => {
            pageSize = parseInt(e.target.value);
            currentPage = 0;
            renderTable();
        });
        
        document.getElementById('prevBtn').addEventListener('click', () => {
            if (currentPage > 0) {
                currentPage--;
                renderTable();
            }
        });
        
        document.getElementById('nextBtn').addEventListener('click', () => {
            const totalPages = Math.ceil(filteredData.length / pageSize);
            if (currentPage < totalPages - 1) {
                currentPage++;
                renderTable();
            }
        });
        
        document.getElementById('exportBtn').addEventListener('click', exportCSV);
        
        document.getElementById('statsToggle').addEventListener('click', () => {
            statsVisible = !statsVisible;
            document.getElementById('statsContent').classList.toggle('hidden', !statsVisible);
            document.getElementById('statsToggle').textContent = statsVisible ? 'ÈùûË°®Á§∫' : 'Ë°®Á§∫';
        });
        
        async function loadFile(file) {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('content').classList.add('hidden');
            document.getElementById('error').classList.add('hidden');
            currentFileName = file.name;
            
            try {
                const buffer = await file.arrayBuffer();
                
                // „É°„Çø„Éá„Éº„Çø„Åã„Çâ„Ç´„É©„É†ÊÉÖÂ†±ÂèñÂæó
                const metadata = await parquetMetadataAsync(buffer);
                const schema = parquetSchema(metadata);
                columns = schema.children.map(col => ({
                    name: col.element.name,
                    type: col.element.type || col.element.converted_type || 'UNKNOWN'
                }));
                
                // hyparquet„Åß„Éë„Éº„ÇπÔºàË°å„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÂΩ¢Âºè„ÅßÂèñÂæóÔºâ
                allData = [];
                await parquetRead({
                    file: buffer,
                    rowFormat: 'object',
                    onComplete: (data) => {
                        if (data && data.length > 0) {
                            allData = data;
                        }
                    }
                });
                
                filteredData = allData;
                currentPage = 0;
                sortColumn = null;
                sortDirection = 'asc';
                
                // Update UI
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('rowCount').textContent = allData.length.toLocaleString();
                document.getElementById('colCount').textContent = columns.length;
                
                calculateStats();
                renderTable();
                
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content').classList.remove('hidden');
                
            } catch (err) {
                console.error(err);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error').textContent = `„Ç®„É©„Éº: ${err.message}`;
                document.getElementById('error').classList.remove('hidden');
            }
        }
        
        function calculateStats() {
            const statsBody = document.getElementById('statsBody');
            const stats = [];
            
            for (const col of columns) {
                const values = allData.map(row => row[col.name]);
                const total = values.length;
                const nullCount = values.filter(v => v === null || v === undefined).length;
                const nonNullValues = values.filter(v => v !== null && v !== undefined);
                const uniqueCount = new Set(nonNullValues.map(v => String(v))).size;
                const nullRate = ((nullCount / total) * 100).toFixed(1);
                
                let min = '-';
                let max = '-';
                if (nonNullValues.length > 0) {
                    const strValues = nonNullValues.map(v => String(v));
                    min = strValues.reduce((a, b) => a < b ? a : b);
                    max = strValues.reduce((a, b) => a > b ? a : b);
                }
                
                stats.push({
                    name: col.name,
                    type: col.type,
                    total: total,
                    nullCount: nullCount,
                    nullRate: nullRate,
                    uniqueCount: uniqueCount,
                    min: min,
                    max: max
                });
            }
            
            statsBody.innerHTML = stats.map((s, idx) => `
                <tr>
                    <td>${idx + 1}</td>
                    <td>${escapeHtml(s.name)}</td>
                    <td>${escapeHtml(s.type)}</td>
                    <td>${s.total.toLocaleString()}</td>
                    <td>${s.nullCount.toLocaleString()}</td>
                    <td>${s.nullRate}%</td>
                    <td>${s.uniqueCount.toLocaleString()}</td>
                    <td title="${escapeHtml(String(s.min))}">${escapeHtml(truncate(String(s.min), 20))}</td>
                    <td title="${escapeHtml(String(s.max))}">${escapeHtml(truncate(String(s.max), 20))}</td>
                </tr>
            `).join('');
        }
        
        function truncate(str, len) {
            if (!str) return '';
            return str.length > len ? str.substring(0, len) + '...' : str;
        }
        
        function sortData(colName) {
            if (sortColumn === colName) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = colName;
                sortDirection = 'asc';
            }
            
            filteredData.sort((a, b) => {
                let valA = a[colName];
                let valB = b[colName];
                
                if (valA === null || valA === undefined) return sortDirection === 'asc' ? 1 : -1;
                if (valB === null || valB === undefined) return sortDirection === 'asc' ? -1 : 1;
                
                if (typeof valA === 'number' && typeof valB === 'number') {
                    return sortDirection === 'asc' ? valA - valB : valB - valA;
                }
                
                const strA = String(valA).toLowerCase();
                const strB = String(valB).toLowerCase();
                if (sortDirection === 'asc') {
                    return strA.localeCompare(strB);
                } else {
                    return strB.localeCompare(strA);
                }
            });
            
            currentPage = 0;
            renderTable();
        }
        
        function renderTable() {
            const start = currentPage * pageSize;
            const end = Math.min(start + pageSize, filteredData.length);
            const pageData = filteredData.slice(start, end);
            
            const thead = document.getElementById('tableHead');
            thead.innerHTML = `<tr><th>#</th>${columns.map(c => {
                const sortIndicator = sortColumn === c.name 
                    ? `<span class="sort-indicator">${sortDirection === 'asc' ? '‚ñ≤' : '‚ñº'}</span>` 
                    : '';
                return `<th data-col="${escapeHtml(c.name)}">
                    <div class="col-name">${escapeHtml(c.name)}${sortIndicator}</div>
                    <div class="col-type">(${escapeHtml(c.type)})</div>
                </th>`;
            }).join('')}</tr>`;
            
            thead.querySelectorAll('th[data-col]').forEach(th => {
                th.addEventListener('click', () => {
                    sortData(th.dataset.col);
                });
            });
            
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = pageData.map((row, idx) => 
                `<tr><td>${start + idx + 1}</td>${columns.map(c => {
                    let val = row[c.name];
                    if (val === null || val === undefined) {
                        return `<td class="null-value">null</td>`;
                    }
                    if (typeof val === 'object') val = JSON.stringify(val);
                    const strVal = String(val);
                    const escaped = escapeHtml(strVal);
                    return `<td title="${escaped}">${escaped}</td>`;
                }).join('')}</tr>`
            ).join('');
            
            const totalPages = Math.ceil(filteredData.length / pageSize) || 1;
            document.getElementById('pageInfo').textContent = `${currentPage + 1} / ${totalPages} „Éö„Éº„Ç∏ (${filteredData.length.toLocaleString()}‰ª∂)`;
            document.getElementById('prevBtn').disabled = currentPage === 0;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages - 1;
        }
        
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function exportCSV() {
            const headers = columns.map(c => c.name);
            const csvContent = [
                headers.map(h => `"${h.replace(/"/g, '""')}"`).join(','),
                ...filteredData.map(row => 
                    headers.map(h => {
                        let val = row[h];
                        if (val === null || val === undefined) return '';
                        if (typeof val === 'object') val = JSON.stringify(val);
                        val = String(val).replace(/"/g, '""');
                        return `"${val}"`;
                    }).join(',')
                )
            ].join('\n');
            
            const bom = '\uFEFF';
            const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFileName.replace(/\.parquet?$/i, '') + '.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
